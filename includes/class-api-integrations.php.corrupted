<?php

/**
 * Handle external API integrations
 */
class EduBot_API_Integrations {

    /**
     * School configuration
     */
    private $school_config;

    /**
     * Security manager instance
     */
    private $security_manager;

    /**
     * Constructor
     */
    public function __construct() {
        $this->school_config = new EduBot_School_Config();
        $this->security_manager = new EduBot_Security_Manager();
    }

    /**
     * Get AI response from OpenAI with security enhancements
     */
    public function get_ai_response($message, $context = '') {
        /**
     * Test email connection with comprehensive validation
     */
    public function test_email_connection($settings) {
        if (empty($settings['provider'])) {
            return array(
                'success' => false,
                'message' => 'Email provider is required'
            );
        }
        
        switch ($settings['provider']) {
            case 'smtp':
                return $this->test_smtp_connection($settings);
            case 'sendgrid':
                return $this->test_sendgrid_connection($settings);
            case 'mailgun':
                return $this->test_mailgun_connection($settings);
            default:
                return array(
                    'success' => false,
                    'message' => 'Unsupported email provider: ' . $settings['provider']
                );
        }
    }
    
    /**
     * Test SMTP connection
     */
    private function test_smtp_connection($settings) {
        if (empty($settings['host']) || empty($settings['username'])) {
            return array(
                'success' => false,
                'message' => 'SMTP host and username are required'
            );
        }
        
        $host = $settings['host'];
        $port = isset($settings['port']) ? intval($settings['port']) : 587;
        
        // Test basic connectivity
        $connection = @fsockopen($host, $port, $errno, $errstr, 10);
        if (!$connection) {
            return array(
                'success' => false,
                'message' => "Cannot connect to SMTP server {$host}:{$port}. Error: {$errstr}"
            );
        }
        
        fclose($connection);
        
        // If we have PHPMailer, try a more comprehensive test
        if (class_exists('PHPMailer\\PHPMailer\\PHPMailer')) {
            return $this->test_phpmailer_smtp($settings);
        }
        
        return array(
            'success' => true,
            'message' => "SMTP server {$host}:{$port} is reachable. Note: Authentication not tested without PHPMailer."
        );
    }
    
    /**
     * Test SMTP with PHPMailer
     */
    private function test_phpmailer_smtp($settings) {
        require_once ABSPATH . WPINC . '/PHPMailer/PHPMailer.php';
        require_once ABSPATH . WPINC . '/PHPMailer/SMTP.php';
        require_once ABSPATH . WPINC . '/PHPMailer/Exception.php';
        
        $mail = new PHPMailer\\PHPMailer\\PHPMailer(true);
        
        try {
            $mail->isSMTP();
            $mail->Host = $settings['host'];
            $mail->SMTPAuth = true;
            $mail->Username = $settings['username'];
            $mail->Password = $settings['password'] ?? '';
            $mail->SMTPSecure = PHPMailer\\PHPMailer\\PHPMailer::ENCRYPTION_STARTTLS;
            $mail->Port = isset($settings['port']) ? intval($settings['port']) : 587;
            $mail->Timeout = 10;
            
            // Test connection without sending
            if ($mail->smtpConnect()) {
                $mail->smtpClose();
                return array(
                    'success' => true,
                    'message' => 'SMTP connection and authentication successful!'
                );
            } else {
                return array(
                    'success' => false,
                    'message' => 'SMTP authentication failed. Please check your credentials.'
                );
            }
        } catch (Exception $e) {
            return array(
                'success' => false,
                'message' => 'SMTP error: ' . $e->getMessage()
            );
        }
    }
    
    /**
     * Test SendGrid API
     */
    private function test_sendgrid_connection($settings) {
        if (empty($settings['api_key'])) {
            return array(
                'success' => false,
                'message' => 'SendGrid API key is required'
            );
        }
        
        $response = wp_remote_get('https://api.sendgrid.com/v3/user/account', array(
            'headers' => array(
                'Authorization' => 'Bearer ' . $settings['api_key'],
                'Content-Type' => 'application/json'
            ),
            'timeout' => 15
        ));
        
        if (is_wp_error($response)) {
            return array(
                'success' => false,
                'message' => 'Network error: ' . $response->get_error_message()
            );
        }
        
        $status_code = wp_remote_retrieve_response_code($response);
        $body = wp_remote_retrieve_body($response);
        $data = json_decode($body, true);
        
        if ($status_code === 200) {
            return array(
                'success' => true,
                'message' => 'SendGrid API connection successful! Account: ' . ($data['username'] ?? 'N/A')
            );
        }
        
        $error_message = isset($data['errors'][0]['message']) ? $data['errors'][0]['message'] : 'Authentication failed';
        return array(
            'success' => false,
            'message' => 'SendGrid API error: ' . $error_message
        );
    }
    
    /**
     * Test Mailgun API
     */
    private function test_mailgun_connection($settings) {
        if (empty($settings['api_key']) || empty($settings['domain'])) {
            return array(
                'success' => false,
                'message' => 'Mailgun API key and domain are required'
            );
        }
        
        $domain = $settings['domain'];
        $response = wp_remote_get("https://api.mailgun.net/v3/{$domain}", array(
            'headers' => array(
                'Authorization' => 'Basic ' . base64_encode('api:' . $settings['api_key']),
                'Content-Type' => 'application/json'
            ),
            'timeout' => 15
        ));
        
        if (is_wp_error($response)) {
            return array(
                'success' => false,
                'message' => 'Network error: ' . $response->get_error_message()
            );
        }
        
        $status_code = wp_remote_retrieve_response_code($response);
        $body = wp_remote_retrieve_body($response);
        $data = json_decode($body, true);
        
        if ($status_code === 200) {
            return array(
                'success' => true,
                'message' => 'Mailgun API connection successful! Domain: ' . $domain
            );
        }
        
        $error_message = isset($data['message']) ? $data['message'] : 'Authentication failed';
        return array(
            'success' => false,
            'message' => 'Mailgun API error: ' . $error_message
        );
    }tion
        if (empty($message) || strlen($message) > 4000) {
            return new WP_Error('invalid_input', 'Message is required and must be under 4000 characters');
        }

        // Security checks
        if ($this->security_manager->is_malicious_content($message)) {
            error_log('EduBot: Malicious content detected in AI request');
            return new WP_Error('security_violation', 'Content violates security policies');
        }

        // Rate limiting
        $user_identifier = $this->get_user_identifier();
        if (!$this->security_manager->check_rate_limit($user_identifier . '_ai_requests', 20, 3600)) {
            return new WP_Error('rate_limit_exceeded', 'Too many AI requests. Please try again later.');
        }

        $api_keys = $this->school_config->get_api_keys();
        
        if (empty($api_keys['openai_key'])) {
            return new WP_Error('missing_api_key', 'OpenAI API key not configured');
        }

        $config = $this->school_config->get_config();
        $model = isset($config['chatbot_settings']['ai_model']) ? 
            sanitize_text_field($config['chatbot_settings']['ai_model']) : 'gpt-3.5-turbo';
        
        // Validate model name
        $allowed_models = array('gpt-3.5-turbo', 'gpt-4', 'gpt-4-turbo-preview');
        if (!in_array($model, $allowed_models)) {
            $model = 'gpt-3.5-turbo';
        }
        
        $system_prompt = $this->build_system_prompt($context);
        
        $data = array(
            'model' => $model,
            'messages' => array(
                array(
                    'role' => 'system',
                    'content' => $system_prompt
                ),
                array(
                    'role' => 'user',
                    'content' => sanitize_text_field($message)
                )
            ),
            'max_tokens' => 500,
            'temperature' => 0.7
        );

        $response = $this->make_openai_request($data, $api_keys['openai_key']);
        
        if (is_wp_error($response)) {
            return $response;
        }
        
        if ($response && isset($response['choices'][0]['message']['content'])) {
            $ai_response = trim($response['choices'][0]['message']['content']);
            
            // Additional security check on AI response
            if ($this->security_manager->is_malicious_content($ai_response)) {
                error_log('EduBot: AI generated potentially malicious content');
                return new WP_Error('ai_security_violation', 'AI response flagged by security filters');
            }
            
            return $ai_response;
        }

        return new WP_Error('ai_error', 'Failed to get AI response');
    }

    /**
     * Get user identifier for rate limiting
     */
    private function get_user_identifier() {
        $ip = isset($_SERVER['REMOTE_ADDR']) ? $_SERVER['REMOTE_ADDR'] : 'unknown';
        $user_agent = isset($_SERVER['HTTP_USER_AGENT']) ? $_SERVER['HTTP_USER_AGENT'] : 'unknown';
        return md5($ip . $user_agent);
    }

    /**
     * Build system prompt for AI
     */
    private function build_system_prompt($context) {
        $config = $this->school_config->get_config();
        $school_name = $config['school_info']['name'];
        $grades = implode(', ', $config['form_settings']['grades']);
        $boards = implode(', ', $config['form_settings']['boards']);
        
        $prompt = "You are an AI admission assistant for {$school_name}. ";
        $prompt .= "Your role is to help prospective parents and students with admission inquiries. ";
        $prompt .= "Available grades: {$grades}. ";
        $prompt .= "Educational boards: {$boards}. ";
        $prompt .= "Be helpful, friendly, and informative. ";
        $prompt .= "If you don't know specific information about the school, politely ask them to contact the school directly. ";
        $prompt .= "Always encourage them to complete the admission application if they seem interested. ";
        $prompt .= "Keep responses concise and helpful. ";
        
        if (!empty($context)) {
            $prompt .= "Additional context: " . $context;
        }

        return $prompt;
    }

    /**
     * Make OpenAI API request with enhanced security
     */
    private function make_openai_request($data, $api_key) {
        $url = 'https://api.openai.com/v1/chat/completions';
        
        // Validate API key format (supports both legacy and project keys)
        if (!preg_match('/^sk-(proj-)?[a-zA-Z0-9_-]{20,}$/', $api_key)) {
            error_log('EduBot: Invalid OpenAI API key format');
            return new WP_Error('invalid_api_key', 'Invalid API key format');
        }
        
        $headers = array(
            'Authorization: Bearer ' . $api_key,
            'Content-Type: application/json',
            'User-Agent: EduBot-Pro-WordPress-Plugin/1.0'
        );

        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, wp_json_encode($data));
        curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_TIMEOUT, 30);
        curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 10);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, true);
        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 2);
        curl_setopt($ch, CURLOPT_FOLLOWLOCATION, false);
        curl_setopt($ch, CURLOPT_MAXREDIRS, 0);

        $response = curl_exec($ch);
        $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        $error = curl_error($ch);
        curl_close($ch);

        if ($error) {
            error_log('EduBot OpenAI cURL Error: ' . $error);
            return new WP_Error('curl_error', 'Network error occurred');
        }

        if ($http_code !== 200) {
            error_log('EduBot OpenAI HTTP Error: ' . $http_code . ' - ' . substr($response, 0, 200));
            return new WP_Error('api_error', 'API request failed with status: ' . $http_code);
        }

        $decoded_response = json_decode($response, true);
        
        if (json_last_error() !== JSON_ERROR_NONE) {
            error_log('EduBot OpenAI JSON Error: ' . json_last_error_msg());
            return new WP_Error('json_error', 'Invalid API response format');
        }

        // Validate response structure
        if (!isset($decoded_response['choices']) || !is_array($decoded_response['choices'])) {
            error_log('EduBot OpenAI: Invalid response structure');
            return new WP_Error('invalid_response', 'Invalid API response structure');
        }

        return $decoded_response;
    }

    /**
     * Send WhatsApp message with security enhancements
     */
    public function send_whatsapp_message($phone, $message) {
        // Input validation
        if (empty($phone) || empty($message)) {
            return new WP_Error('missing_data', 'Phone number and message are required');
        }

        // Validate and sanitize phone number
        $phone = $this->validate_phone_number($phone);
        if (is_wp_error($phone)) {
            return $phone;
        }

        // Validate message length and content
        if (strlen($message) > 4096) {
            return new WP_Error('message_too_long', 'Message exceeds maximum length');
        }

        if ($this->security_manager->is_malicious_content($message)) {
            error_log('EduBot: Malicious content detected in WhatsApp message');
            return new WP_Error('security_violation', 'Message violates security policies');
        }

        // Rate limiting for WhatsApp messages
        $rate_key = 'whatsapp_' . md5($phone);
        if (!$this->security_manager->check_rate_limit($rate_key, 5, 3600)) {
            return new WP_Error('rate_limit_exceeded', 'Too many messages to this number. Please try again later.');
        }

        $api_keys = $this->school_config->get_api_keys();
        
        if (empty($api_keys['whatsapp_token']) || empty($api_keys['whatsapp_provider'])) {
            return new WP_Error('missing_config', 'WhatsApp configuration not found');
        }

        $message = sanitize_text_field($message);

        switch ($api_keys['whatsapp_provider']) {
            case 'twilio':
                return $this->send_twilio_whatsapp($phone, $message, $api_keys);
                
            case '360dialog':
                return $this->send_360dialog_whatsapp($phone, $message, $api_keys);
                
            case 'wati':
                return $this->send_wati_whatsapp($phone, $message, $api_keys);
                
            default:
                return $this->send_generic_whatsapp($phone, $message, $api_keys);
        }
    }

    /**
     * Validate and format phone number
     */
    private function validate_phone_number($phone) {
        // Remove all non-digit characters except +
        $phone = preg_replace('/[^0-9+]/', '', $phone);
        
        // Check if phone number is valid
        if (empty($phone) || strlen($phone) < 10 || strlen($phone) > 15) {
            return new WP_Error('invalid_phone', 'Invalid phone number format');
        }

        // Ensure it starts with + for international format
        if (substr($phone, 0, 1) !== '+') {
            $phone = '+' . $phone;
        }

        return $phone;
    }

    /**
     * Send WhatsApp via Twilio
     */
    private function send_twilio_whatsapp($phone, $message, $api_keys) {
        $account_sid = $api_keys['whatsapp_token'];
        $auth_token = isset($api_keys['twilio_auth_token']) ? $api_keys['twilio_auth_token'] : '';
        $from = isset($api_keys['whatsapp_phone_id']) ? $api_keys['whatsapp_phone_id'] : '';

        if (empty($auth_token) || empty($from)) {
            return false;
        }

        $url = "https://api.twilio.com/2010-04-01/Accounts/{$account_sid}/Messages.json";
        
        $data = array(
            'From' => 'whatsapp:' . $from,
            'To' => 'whatsapp:' . $phone,
            'Body' => $message
        );

        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($data));
        curl_setopt($ch, CURLOPT_USERPWD, $account_sid . ':' . $auth_token);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_TIMEOUT, 30);

        $response = curl_exec($ch);
        $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        curl_close($ch);

        return $http_code === 201;
    }

    /**
     * Send WhatsApp via 360Dialog
     */
    private function send_360dialog_whatsapp($phone, $message, $api_keys) {
        $api_key = $api_keys['whatsapp_token'];
        $url = 'https://waba.360dialog.io/v1/messages';
        
        $data = array(
            'to' => $phone,
            'type' => 'text',
            'text' => array(
                'body' => $message
            )
        );

        $headers = array(
            'D360-API-KEY: ' . $api_key,
            'Content-Type: application/json'
        );

        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
        curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_TIMEOUT, 30);

        $response = curl_exec($ch);
        $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        curl_close($ch);

        return $http_code === 200;
    }

    /**
     * Send email
     */
    public function send_email($to, $subject, $message, $headers = array()) {
        $api_keys = $this->school_config->get_api_keys();
        $email_service = isset($api_keys['email_service']) ? $api_keys['email_service'] : 'smtp';

        switch ($email_service) {
            case 'sendgrid':
                return $this->send_sendgrid_email($to, $subject, $message, $api_keys);
                
            case 'mailgun':
                return $this->send_mailgun_email($to, $subject, $message, $api_keys);
                
            case 'ses':
                return $this->send_ses_email($to, $subject, $message, $api_keys);
                
            default:
                return $this->send_smtp_email($to, $subject, $message, $headers, $api_keys);
        }
    }

    /**
     * Send email via SMTP
     */
    private function send_smtp_email($to, $subject, $message, $headers, $api_keys) {
        // Configure SMTP settings if provided
        if (!empty($api_keys['smtp_host'])) {
            add_action('phpmailer_init', function($phpmailer) use ($api_keys) {
                $phpmailer->isSMTP();
                $phpmailer->Host = $api_keys['smtp_host'];
                $phpmailer->SMTPAuth = true;
                $phpmailer->Port = isset($api_keys['smtp_port']) ? $api_keys['smtp_port'] : 587;
                $phpmailer->Username = $api_keys['smtp_username'];
                $phpmailer->Password = $api_keys['smtp_password'];
                $phpmailer->SMTPSecure = $phpmailer->Port == 465 ? 'ssl' : 'tls';
            });
        }

        return wp_mail($to, $subject, $message, $headers);
    }

    /**
     * Send email via SendGrid
     */
    private function send_sendgrid_email($to, $subject, $message, $api_keys) {
        if (empty($api_keys['email_api_key'])) {
            return false;
        }

        $config = $this->school_config->get_config();
        $from_email = $config['school_info']['contact_info']['email'];
        $from_name = $config['school_info']['name'];

        $data = array(
            'personalizations' => array(
                array(
                    'to' => array(array('email' => $to))
                )
            ),
            'from' => array(
                'email' => $from_email,
                'name' => $from_name
            ),
            'subject' => $subject,
            'content' => array(
                array(
                    'type' => 'text/plain',
                    'value' => $message
                )
            )
        );

        $headers = array(
            'Authorization: Bearer ' . $api_keys['email_api_key'],
            'Content-Type: application/json'
        );

        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, 'https://api.sendgrid.com/v3/mail/send');
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
        curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_TIMEOUT, 30);

        $response = curl_exec($ch);
        $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        curl_close($ch);

        return $http_code === 202;
    }

    /**
     * Test OpenAI connection with comprehensive validation
     */
    public function test_openai_connection($api_key) {
        if (empty($api_key)) {
            return array(
                'success' => false,
                'message' => 'OpenAI API key is required'
            );
        }
        
        // Validate API key format
        if (!preg_match('/^sk-(proj-)?[a-zA-Z0-9_-]{20,}$/', $api_key)) {
            return array(
                'success' => false,
                'message' => 'Invalid OpenAI API key format'
            );
        }
        
        $data = array(
            'model' => 'gpt-3.5-turbo',
            'messages' => array(
                array(
                    'role' => 'user',
                    'content' => 'Test connection - please respond with "Connection successful"'
                )
            ),
            'max_tokens' => 50,
            'temperature' => 0.1
        );

        $response = $this->make_openai_request($data, $api_key);
        
        if (is_wp_error($response)) {
            return array(
                'success' => false,
                'message' => 'OpenAI API Error: ' . $response->get_error_message()
            );
        }
        
        if ($response && isset($response['choices'][0]['message']['content'])) {
            return array(
                'success' => true,
                'message' => 'OpenAI connection successful! Response: ' . trim($response['choices'][0]['message']['content'])
            );
        }
        
        return array(
            'success' => false,
            'message' => 'Invalid response from OpenAI API'
        );
    }

    /**
     * Test WhatsApp connection with comprehensive validation
     */
    public function test_whatsapp_connection($token, $provider, $phone_id = '') {
        if (empty($token)) {
            return array(
                'success' => false,
                'message' => 'WhatsApp token is required'
            );
        }
        
        if (empty($provider)) {
            return array(
                'success' => false,
                'message' => 'WhatsApp provider is required'
            );
        }
        
        switch ($provider) {
            case 'meta':
                return $this->test_meta_whatsapp($token, $phone_id);
            case 'twilio':
                return $this->test_twilio_whatsapp($token);
            default:
                return array(
                    'success' => false,
                    'message' => 'Unsupported WhatsApp provider: ' . $provider
                );
        }
    }
    
    /**
     * Test Meta WhatsApp Business API
     */
    private function test_meta_whatsapp($token, $phone_id) {
        if (empty($phone_id)) {
            return array(
                'success' => false,
                'message' => 'Phone ID is required for Meta WhatsApp API'
            );
        }
        
        $url = "https://graph.facebook.com/v17.0/{$phone_id}";
        
        $response = wp_remote_get($url, array(
            'headers' => array(
                'Authorization' => 'Bearer ' . $token,
                'Content-Type' => 'application/json'
            ),
            'timeout' => 15
        ));
        
        if (is_wp_error($response)) {
            return array(
                'success' => false,
                'message' => 'Network error: ' . $response->get_error_message()
            );
        }
        
        $status_code = wp_remote_retrieve_response_code($response);
        $body = wp_remote_retrieve_body($response);
        $data = json_decode($body, true);
        
        if ($status_code === 200 && isset($data['id'])) {
            return array(
                'success' => true,
                'message' => 'Meta WhatsApp API connection successful! Phone number: ' . ($data['display_phone_number'] ?? 'N/A')
            );
        }
        
        $error_message = isset($data['error']['message']) ? $data['error']['message'] : 'Unknown error';
        return array(
            'success' => false,
            'message' => 'Meta WhatsApp API error: ' . $error_message
        );
    }
    
    /**
     * Test Twilio WhatsApp API
     */
    private function test_twilio_whatsapp($token) {
        // Extract Account SID and Auth Token from the token (format: SID:TOKEN)
        $credentials = explode(':', $token);
        if (count($credentials) !== 2) {
            return array(
                'success' => false,
                'message' => 'Invalid Twilio token format. Expected: AccountSID:AuthToken'
            );
        }
        
        list($account_sid, $auth_token) = $credentials;
        
        $url = "https://api.twilio.com/2010-04-01/Accounts/{$account_sid}.json";
        
        $response = wp_remote_get($url, array(
            'headers' => array(
                'Authorization' => 'Basic ' . base64_encode($account_sid . ':' . $auth_token),
                'Content-Type' => 'application/json'
            ),
            'timeout' => 15
        ));
        
        if (is_wp_error($response)) {
            return array(
                'success' => false,
                'message' => 'Network error: ' . $response->get_error_message()
            );
        }
        
        $status_code = wp_remote_retrieve_response_code($response);
        $body = wp_remote_retrieve_body($response);
        $data = json_decode($body, true);
        
        if ($status_code === 200 && isset($data['sid'])) {
            return array(
                'success' => true,
                'message' => 'Twilio WhatsApp API connection successful! Account: ' . ($data['friendly_name'] ?? $data['sid'])
            );
        }
        
        $error_message = isset($data['message']) ? $data['message'] : 'Authentication failed';
        return array(
            'success' => false,
            'message' => 'Twilio WhatsApp API error: ' . $error_message
        );
    }

    /**
     * Test email connection
     */
    public function test_email_connection($settings) {
        if ($settings['provider'] === 'smtp') {
            if (empty($settings['host']) || empty($settings['username'])) {
                return false;
            }
            
            // Test SMTP connection
            $smtp = fsockopen($settings['host'], $settings['port'], $errno, $errstr, 10);
            if ($smtp) {
                fclose($smtp);
                return true;
            }
            return false;
        }
        
        // For API-based services, check if API key is provided
        return !empty($settings['api_key']);
    }

    /**
     * Generic WhatsApp sender (for custom APIs)
     */
    private function send_generic_whatsapp($phone, $message, $api_keys) {
        // This method can be customized for other WhatsApp providers
        // or custom API implementations
        return false;
    }

    /**
     * Send SMS
     */
    public function send_sms($phone, $message) {
        $api_keys = $this->school_config->get_api_keys();
        
        if (empty($api_keys['sms_provider']) || empty($api_keys['sms_api_key'])) {
            return false;
        }

        switch ($api_keys['sms_provider']) {
            case 'twilio':
                return $this->send_twilio_sms($phone, $message, $api_keys);
                
            case 'textlocal':
                return $this->send_textlocal_sms($phone, $message, $api_keys);
                
            case 'msg91':
                return $this->send_msg91_sms($phone, $message, $api_keys);
                
            default:
                return false;
        }
    }

    /**
     * Send SMS via Twilio
     */
    private function send_twilio_sms($phone, $message, $api_keys) {
        $account_sid = $api_keys['sms_api_key'];
        $auth_token = isset($api_keys['twilio_auth_token']) ? $api_keys['twilio_auth_token'] : '';
        $from = isset($api_keys['sms_sender_id']) ? $api_keys['sms_sender_id'] : '';

        if (empty($auth_token) || empty($from)) {
            return false;
        }

        $url = "https://api.twilio.com/2010-04-01/Accounts/{$account_sid}/Messages.json";
        
        $data = array(
            'From' => $from,
            'To' => $phone,
            'Body' => $message
        );

        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($data));
        curl_setopt($ch, CURLOPT_USERPWD, $account_sid . ':' . $auth_token);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_TIMEOUT, 30);

        $response = curl_exec($ch);
        $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        curl_close($ch);

        return $http_code === 201;
    }

    /**
     * Send SMS via TextLocal
     */
    private function send_textlocal_sms($phone, $message, $api_keys) {
        $api_key = $api_keys['sms_api_key'];
        $sender = isset($api_keys['sms_sender_id']) ? $api_keys['sms_sender_id'] : 'SCHOOL';

        $data = array(
            'apikey' => $api_key,
            'numbers' => $phone,
            'message' => $message,
            'sender' => $sender
        );

        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, 'https://api.textlocal.in/send/');
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($data));
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_TIMEOUT, 30);

        $response = curl_exec($ch);
        $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        curl_close($ch);

        if ($http_code === 200) {
            $decoded = json_decode($response, true);
            return isset($decoded['status']) && $decoded['status'] === 'success';
        }

        return false;
    }
}
